version: '1.0'
stages:
  - build
  - test
steps:
  main_clone:
    title: Cloning main repository...
    stage: build
    type: git-clone
    repo: 'kurumai/circleci-demo-java-spring'
    revision: ci-tools
    git: github

  build:
    title: build
    stage: build
    image: gradle:jdk11
    commands:
      - ./gradlew build -x test --no-daemon --build-cache --gradle-user-home=/codefresh/volume/.gradle -Dmaven.repo.local=/codefresh/volume/m2
  Test:
    title: Compile/Unit test
    stage: test
    image: gradle:jdk11
    services:
      name: postgres
      composition:
        postgres:
          image: postgres:12-alpine
          environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_DB=circle_test
          ports:
            - 5432
    commands:
      - ./gradlew test --no-daemon --build-cache --gradle-user-home=/codefresh/volume/.gradle -Dmaven.repo.local=/codefresh/volume/m2 --tests com.circleci.demojavaspring.\*Test,com.circleci.demojavaspring.postgres.*Test
      - ./gradlew jacocoTestReport
      - ./gradlew assemble
