stages:
    - build
    - test

before_script:
    - chmod +x ./gradlew
    - export GRADLE_USER_HOME=`pwd`/.gradle

services:
    - postgres:12-alpine

variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_DB: circle_test
    POSTGRES_HOST_AUTH_METHOD: trust

build:
    except: # except or only
        - ci-tools@kurumai/circleci-demo-java-spring
    stage: build
    image: openjdk:11.0.3-jdk-stretch
    script:
        - ./gradlew build -x test
    artifacts:
        name: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}"
        paths:
            - build/libs/*.jar

test:
    except: # except or only
        - ci-tools@kurumai/circleci-demo-java-spring
    stage: test
    image: openjdk:11.0.3-jdk-stretch
    script:
        - ./gradlew test
        - ./gradlew jacocoTestReport
